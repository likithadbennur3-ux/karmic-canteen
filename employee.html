<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Employee — Karmic Canteen</title>
<style>
  body{
    background: url('https://images.unsplash.com/photo-1600891964599-f61ba0e24092?w=1600&q=80&auto=format&fit=crop') center/cover no-repeat;
    color:#fff;font-family:Poppins, sans-serif;
    padding:24px; min-height:100vh;
  }
  h1{margin-top:10px;color:#ffcc00;text-shadow:0 3px 8px rgba(0,0,0,.6);}
  .foods{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:18px;max-width:1000px;margin-top:20px;}
  .food{background:rgba(255,255,255,0.08);border-radius:10px;padding:8px;text-align:center;cursor:pointer;transition:all .2s; border:2px solid transparent;}
  .food img{width:100%;height:120px;object-fit:cover;border-radius:8px;}
  .food p{margin:8px 0 0;font-weight:600}
  .food:hover{transform:scale(1.03)}
  .food.selected{border-color:#ffcc00;transform:scale(1.04);background:rgba(255,204,0,0.08)}
  .controls{margin-top:20px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
  input[type="text"]{padding:10px;border-radius:8px;border:none;min-width:220px}
  button{background:#ff9800;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;color:#fff}
  #status{margin-left:12px;font-size:.95rem}
  .log{margin-top:18px;background:rgba(0,0,0,0.5);padding:12px;border-radius:8px;max-width:1000px;white-space:pre-wrap}
</style>
</head>
<body>
  <h1>Select Your Meal</h1>

  <div class="foods" id="foods">
    <!-- cards inserted by JS -->
  </div>

  <div class="controls">
    <input id="employeeName" type="text" placeholder="Enter your name"/>
    <button id="submitBtn">Submit Meal</button>
    <button id="resetBtn">Reset Selection</button>
    <span id="status"></span>
  </div>

  <div class="log" id="log" aria-live="polite"></div>

<script>
const foodsData = [
  "Poori",
  "Chapathi",
  "Paneer Butter Masala",
  "Butter Naan",
  "Roti",
  "Chicken Fry",
  "Salad",
  "Pulav"
];

const foodsContainer = document.getElementById('foods');
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');

function log(msg){
  console.log(msg);
  logEl.textContent = (new Date()).toLocaleTimeString() + " — " + msg + "\n" + logEl.textContent;
}

function buildCards(){
  foodsData.forEach(name=>{
    const div = document.createElement('div');
    div.className = 'food';
    // fallback placeholder images (replace with your images or keep these)
    const safeName = encodeURIComponent(name);
    const img = `https://source.unsplash.com/featured/?${safeName},indian-food`;
    div.innerHTML = `<img src="${img}" alt="${name}"><p>${name}</p>`;
    div.addEventListener('click', ()=>div.classList.toggle('selected'));
    foodsContainer.appendChild(div);
  });
}

buildCards();

document.getElementById('resetBtn').addEventListener('click', ()=>{
  document.querySelectorAll('.food.selected').forEach(el=>el.classList.remove('selected'));
  log('Selection reset by user.');
});

document.getElementById('submitBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('employeeName').value.trim();
  const selectedEls = Array.from(document.querySelectorAll('.food.selected'));
  if(!name){ alert('Please enter your name.'); return; }
  if(selectedEls.length === 0){ alert('Please select at least one meal.'); return; }

  const meals = selectedEls.map(el => el.querySelector('p').textContent);
  log('Preparing to send: ' + JSON.stringify({employee_name: name, meals}));

  statusEl.textContent = 'Saving…';
  try {
    const res = await fetch('save_meal.php', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ employee_name: name, meals })
    });

    const text = await res.text(); // get raw text so we can show errors if not JSON
    let data;
    try { data = JSON.parse(text); } catch(e) {
      throw new Error('Server did not return valid JSON. Raw response: ' + text);
    }

    if(data.status === 'success'){
      statusEl.textContent = 'Saved ✓';
      log('Save successful. Insert ID: ' + (data.insertId || 'N/A'));
      // optional: clear form
      document.getElementById('employeeName').value = '';
      document.querySelectorAll('.food.selected').forEach(el=>el.classList.remove('selected'));
    } else {
      statusEl.textContent = 'Error';
      throw new Error('Server error: ' + (data.message || JSON.stringify(data)));
    }
  } catch(err) {
    statusEl.textContent = 'Failed';
    log('ERROR: ' + err.message);
    alert('Submission failed — check console/log for details.');
  }
});
</script>
</body>
</html>
